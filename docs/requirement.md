# 基金净值 3 分钟自动获取能力 - 需求拆分与设计思考

## 1. 目标与范围

目标：在现有插件中新增“按交易日 + 交易时段”的净值自动获取能力，并将历史净值存储升级为按月分表，保障后续数据量增长下的可维护性与查询性能。

本次需求范围：
1. 插件启动后自动激活每日调度逻辑。
2. 每日根据节假日接口判断是否工作日，并走不同同步策略。
3. 历史净值改为按 `YYYY_MM_` 前缀分表存储。
4. 新增调度与入库过程中的错误兜底、无效数据过滤与幂等保护。

---

## 2. 当前实现现状（基于代码）

1. `services/nav_sync_service.py`
   - 现有为单一后台循环任务：启动后等待 15 秒，按固定间隔（默认 1800 秒）同步一次。
   - 同步对象为 `list_position_funds()`，即“当前有持仓”的基金，不是“所有已注册基金”。
   - 无工作日判断、无交易时段窗口、无日级任务编排。

2. `data_handler.py`
   - 历史净值使用单表 `fund_nav_history`。
   - 读写方法（`upsert_fund_nav_history`、`list_fund_nav_history`、`get_latest_nav_date` 等）均固定依赖该单表。
   - 暂无按月分表策略，也无历史数据迁移机制。

3. `main.py`
   - 插件初始化时通过 `_ensure_nav_sync_task()` 启动净值同步任务。
   - 现有流程未区分工作日和非工作日。

---

## 3. 需求拆分（可直接进入开发排期）

## 3.1 每日调度与工作日判断

### 3.1.1 新增“每日判定任务”
1. 插件启动时确保每日调度任务存在（仅单实例，防重复启动）。
2. 每天执行一次“当日类型判定”：
   - 请求 `http://api.haoshenqi.top/holiday?date=YYYY-MM-DD`
   - `status` 映射：
     - `0` 普通工作日 -> 交易日
     - `2` 补班工作日 -> 交易日
     - `1` 周末 -> 非交易日
     - `3` 法定节假日 -> 非交易日
3. 判定后分支：
   - 交易日：启动当日盘中 3 分钟同步任务。
   - 非交易日：仅执行一次“全基金净值更新任务”。
   - 产生错误时自动重试，重试3次后仍然错误，尝试降级使用本地规则（`Mon-Fri` 工作日，`Sat/Sun` 非工作日）。

### 3.1.2 交易日盘中 3 分钟同步任务
1. 有效时间窗口：`09:40` 到 `14:55`（含边界时刻）。
2. 触发频率：每 3 分钟一次。
3. 同步对象：已注册基金（建议定义为 `funds` 表中全部基金，而不是仅持仓基金）。
4. 任务互斥：同一时刻只允许一个净值同步执行，避免并发写库冲突。
5. 跨日保护：到次日后自动退出当日盘中任务，由每日判定任务重新编排。

### 3.1.3 非交易日全量更新任务
1. 当天仅触发一次。
2. 同步对象：已注册基金（`funds` 全量）。
3. 不进入 3 分钟循环。

## 3.2 历史净值按月分表

### 3.2.1 分表命名
1. 按要求使用 `YYYY_MM_` 前缀。
2. 示例：`2026_02_fund_nav_history`（注意：表名以数字开头时，SQL 需统一安全引用）。
3. 每月首次写入前自动建表（懒创建）。

### 3.2.2 分表结构（与现有主表对齐）
字段建议沿用现有 `fund_nav_history`：
1. `fund_id`
2. `nav_date`
3. `unit_nav`
4. `accum_nav`
5. `change_rate`
6. `source`
7. `created_at`
8. `updated_at`
9. 主键：`(fund_id, nav_date)`
10. 索引：`(fund_id, nav_date DESC)`

### 3.2.3 读写路由策略
1. 写入：
   - 根据 `nav_date` 路由到对应月表。
   - 仍保持 `ON CONFLICT(fund_id, nav_date)` 幂等更新。
2. 查询：
   - `get_latest_nav_date` / `get_latest_nav_record`：跨所有分表取最新。
   - `list_fund_nav_history(start_date/end_date)`：按时间范围推导涉及月份，只查相关分表并合并排序。
   - `get_nav_on_or_after`：从起始月份向后查询，命中即返回。

### 3.2.4 迁移与兼容
1. `schema_version` 升级（例如 `3 -> 4`）。
2. 迁移策略建议：
   - 保留旧表 `fund_nav_history` 作为回滚保障。
   - 启动迁移任务按月搬迁旧数据到新分表（可分批）。
   - 迁移完成后读路径优先分表，必要时兼容旧表兜底读取。
3. 避免“一次性全量迁移阻塞插件启动”。

## 3.3 错误兜底与无效数据防护

### 3.3.1 节假日接口兜底
1. 网络失败、超时、返回非 JSON、`status` 缺失或非法值时：
   - 记录告警日志。
   - 降级使用本地规则（`Mon-Fri` 视为工作日，`Sat/Sun` 非工作日）。
2. 当日判定结果可做内存缓存，避免重复请求。

### 3.3.2 净值数据有效性校验
1. 严格校验 `fund_code`、`nav_date`、`unit_nav`：
   - `nav_date` 必须可解析为 `YYYY-MM-DD`
   - `unit_nav > 0`
2. 对无效记录执行“跳过 + 记录错误”，不影响同批其他基金写入。
3. 对单只基金同步失败，统计失败并继续处理后续基金。

### 3.3.3 任务稳定性
1. 每日任务与盘中任务均需 `try/except` 外层保护，避免协程退出后无人重启。
2. 任务取消（插件卸载）时要可优雅停止。
3. 添加关键日志：
   - 今日是否工作日
   - 创建/取消了哪些任务
   - 每轮同步基金数、成功数、失败数、写入条数
   - 主要异常摘要

---

## 4. 开发任务清单（建议顺序）

1. 调度框架改造（`NavSyncService`）
   - 拆分为“每日判定任务”+“盘中循环任务”
   - 加入任务状态与互斥控制
2. 交易日判断模块
   - 新增 holiday API client（可放 `services/`）
   - 实现状态映射、超时、重试与降级
3. “已注册基金”同步路径
   - 新增同步入口支持 `funds` 全量基金
   - 保留按持仓同步能力（兼容现有命令）
4. 按月分表改造（`DataHandler`）
   - 动态建表、写入路由、跨表查询
   - schema version 升级与迁移逻辑
5. 稳定性补强
   - 无效数据过滤、错误聚合、日志标准化
6. 回归验证
   - 启动后任务行为
   - 工作日/非工作日分支
   - 盘中窗口触发正确性
   - 分表写入与跨表查询正确性

---

## 5. 验收标准（建议）

1. 插件启动后自动存在每日判定任务，且不会重复创建多个同类任务。
2. 工作日会在 `09:40` 至 `14:55` 之间每 3 分钟触发净值同步。
3. 非工作日只触发一次全基金净值更新，不进行盘中循环。
4. 历史净值写入按月落入 `YYYY_MM_` 前缀分表。
5. 跨月查询结果与改造前一致（同条件下数据不丢失、不重复）。
6. 任意单次接口失败或脏数据不会导致整个自动任务退出。

---

## 6. 补充思考与待确认项

1. “已注册基金”定义需统一：
   - 倾向使用 `funds` 全量；若只同步持仓基金，需明确为业务规则。
2. 时区建议固定 `Asia/Shanghai`，避免部署环境时区导致触发漂移。
3. `09:40~14:55` 是否包含端点需明确定义（本文按“包含”处理）。
4. 分表命名以数字开头会增加 SQL 引用复杂度；
   - 若允许调整，建议改为 `fund_nav_history_YYYY_MM`（可读性和 SQL 兼容更好）。
5. 非交易日“仅尝试更新”是否允许手动命令触发额外更新，需要明确。
6. 历史旧数据迁移策略（立即迁移 / 按需迁移 / 后台渐进迁移）需最终拍板。

